# CodeMagic CI/CD Configuration
# VR Avatar App - Flutter + Unity as Library
# GPUæœ€é©åŒ–ãƒ»Neural Engineå¯¾å¿œiOSå°‚ç”¨ã‚¢ãƒ—ãƒª

workflows:
  ios-workflow:
    name: iOS VR Avatar App
    max_build_duration: 120
    instance_type: mac_mini_m1
    # integrations:
    #   app_store_connect: codemagic
    environment:
      # ios_signing:
      #   distribution_type: development
      #   bundle_identifier: com.vr.avatar1
      vars:
        XCODE_WORKSPACE: "ios/Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        BUNDLE_ID: "com.example.vr_avatar_app"
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      # - name: Set up provisioning profiles
      #   script: |
      #     # CodeMagicè‡ªå‹•ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
      #     xcode-project use-profiles
      
      - name: Get Flutter packages
        script: |
          echo "ğŸ“¦ Installing Flutter dependencies..."
          flutter clean
          flutter packages pub get
          flutter precache --ios
          
          # flutter_unity_widget ä¾å­˜é–¢ä¿‚ç¢ºèª
          echo "ğŸ” Checking flutter_unity_widget..."
          flutter packages pub deps | grep flutter_unity_widget || echo "âš ï¸ flutter_unity_widget not found"
          
          # pubspec.yaml ç¢ºèª
          echo "ğŸ“‹ pubspec.yaml dependencies:"
          grep -A 20 "dependencies:" pubspec.yaml
          
      - name: Verify Flutter iOS setup
        script: |
          echo "ğŸ” Verifying Flutter iOS configuration..."
          
          # Generated.xcconfigç¢ºèª
          if [ -f "ios/Flutter/Generated.xcconfig" ]; then
            echo "âœ… Generated.xcconfig exists"
            cat ios/Flutter/Generated.xcconfig
          else
            echo "âŒ Generated.xcconfig missing - regenerating..."
            flutter build ios --config-only
          fi
          
          # flutter_export_environment.shç¢ºèª
          if [ -f "ios/Flutter/flutter_export_environment.sh" ]; then
            echo "âœ… flutter_export_environment.sh exists"
          else
            echo "âŒ flutter_export_environment.sh missing"
            exit 1
          fi
          
      # - name: Unity Framework Headers Validation
      #   script: |
      #     # Unity Framework headersç¢ºèªãƒ»å¾©å…ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆ
      #     cd ios
      #     
      #     # Headers ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
      #     HEADERS_DIR="Frameworks/UnityFramework.framework/Headers"
      #     
      #     if [ ! -d "$HEADERS_DIR" ]; then
      #       echo "ğŸ”§ Creating Headers directory..."
      #       mkdir -p "$HEADERS_DIR"
      #     fi
      #     
      #     # å¿…é ˆãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
      #     REQUIRED_HEADERS=("UnityFramework.h" "UnityAppController.h" "RenderPluginDelegate.h" "LifeCycleListener.h")
      #     
      #     for header in "${REQUIRED_HEADERS[@]}"; do
      #       if [ ! -f "$HEADERS_DIR/$header" ]; then
      #         echo "âš ï¸  Missing header: $header"
      #         echo "ğŸ”§ Restoring from Git repository..."
      #         
      #         # Git ã‹ã‚‰å¾©å…ƒã‚’è©¦è¡Œ
      #         if git show HEAD:"ios/Frameworks/UnityFramework.framework/Headers/$header" > "$HEADERS_DIR/$header" 2>/dev/null; then
      #           echo "âœ… Restored $header from Git"
      #         else
      #           echo "âŒ Failed to restore $header from Git"
      #           exit 1
      #         fi
      #       else
      #         echo "âœ… $header exists"
      #       fi
      #     done
      #     
      #     echo "ğŸ¯ All Unity Framework headers validated successfully!"
      #     cd ..
      
      - name: Unity as Libraryè‡ªå‹•å±•é–‹
        script: |
          # Unity as Library ZIPå±•é–‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
          cd ios
          
          # 1. UnityFramework.framework å±•é–‹
          if [ -f "UnityFramework.zip" ]; then
            echo "ğŸ“¦ Extracting UnityFramework.zip..."
            unzip -o UnityFramework.zip -d ./
            echo "âœ… UnityFramework.framework extracted successfully"
            
            # å±•é–‹ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
            echo "ğŸ” Extracted files:"
            ls -la ./
            
            # UnityFramework ãƒã‚¤ãƒŠãƒªã‚’é©åˆ‡ãªå ´æ‰€ã«é…ç½®
            if [ -f "./UnityFramework" ]; then
              echo "ğŸ“± Moving UnityFramework binary to framework structure..."
              mkdir -p "Frameworks/UnityFramework.framework"
              mv "./UnityFramework" "Frameworks/UnityFramework.framework/"
              echo "âœ… UnityFramework binary moved"
            fi
            
            echo "Size: $(du -sh Frameworks/UnityFramework.framework 2>/dev/null || echo 'Framework not found')"
          else
            echo "âš ï¸  UnityFramework.zip not found - creating empty framework structure"
          fi
          
          # 2. Frameworkæ§‹é€ ã‚’ç¢ºå®Ÿã«ä½œæˆ
          mkdir -p "Frameworks/UnityFramework.framework/Headers"
          mkdir -p "Frameworks/UnityFramework.framework/Data"
          
          # 3. Info.plistã‚’ä½œæˆ
          printf '%s\n' '<?xml version="1.0" encoding="UTF-8"?>' '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' '<plist version="1.0">' '<dict>' '	<key>CFBundleExecutable</key>' '	<string>UnityFramework</string>' '	<key>CFBundleIdentifier</key>' '	<string>com.example.UnityFramework</string>' '	<key>CFBundlePackageType</key>' '	<string>FMWK</string>' '	<key>CFBundleVersion</key>' '	<string>1.0</string>' '</dict>' '</plist>' > "Frameworks/UnityFramework.framework/Info.plist"
          
          # 4. UnityLibraries å±•é–‹
          if [ -f "UnityLibraries.zip" ]; then
            echo "ğŸ“¦ Extracting UnityLibraries.zip..."
            unzip -o UnityLibraries.zip -d ./
            echo "âœ… Unity Libraries extracted successfully"
            
            # Libraries ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
            mkdir -p "Libraries"
            
            # å±•é–‹ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
            for lib in baselib.a libiPhone-lib.a libUnityARKit.a; do
              if [ -f "./$lib" ]; then
                echo "ğŸ“š Moving $lib to Libraries/"
                mv "./$lib" "Libraries/"
              fi
            done
            
            # Libraries é…ç½®ç¢ºèª
            if [ -d "Libraries" ]; then
              echo "ğŸ“‚ Unity Libraries structure:"
              ls -la Libraries/
              echo "Total size: $(du -sh Libraries/)"
            fi
          else
            echo "âš ï¸  UnityLibraries.zip not found - creating empty Libraries structure"
            mkdir -p "Libraries"
          fi
          
          # 5. Unity Framework å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯
          FRAMEWORK_PATH="Frameworks/UnityFramework.framework"
          if [ -d "$FRAMEWORK_PATH" ]; then
            echo "ğŸ” Unity Framework validation..."
            
            # å®Ÿè¡Œãƒã‚¤ãƒŠãƒªç¢ºèª
            if [ -f "$FRAMEWORK_PATH/UnityFramework" ]; then
              echo "âœ… UnityFramework binary exists"
              file "$FRAMEWORK_PATH/UnityFramework"
            else
              echo "âš ï¸  UnityFramework binary missing - creating placeholder"
              # ç©ºã®ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
              touch "$FRAMEWORK_PATH/UnityFramework"
            fi
            
            # Info.plist ç¢ºèª
            if [ -f "$FRAMEWORK_PATH/Info.plist" ]; then
              echo "âœ… Info.plist exists"
            else
              echo "âŒ Info.plist missing!"
              exit 1
            fi
            
            # Headers ç¢ºèªãƒ»ç”Ÿæˆ
            if [ -d "$FRAMEWORK_PATH/Headers" ]; then
              echo "âœ… Headers directory exists"
              ls -la "$FRAMEWORK_PATH/Headers/"
            else
              echo "âš ï¸  Headers directory missing - creating..."
              mkdir -p "$FRAMEWORK_PATH/Headers"
              
              # åŸºæœ¬çš„ãªUnityFramework.hã‚’ç”Ÿæˆ
              printf '%s\n' '#import <Foundation/Foundation.h>' '' 'NS_ASSUME_NONNULL_BEGIN' '' '@protocol UnityFrameworkListener <NSObject>' '- (void)unityDidUnload:(NSNotification*)notification;' '- (void)unityDidQuit:(NSNotification*)notification;' '@end' '' '@interface UnityFramework : NSObject' '+ (UnityFramework*)getInstance;' '- (void)setDataBundleId:(const char*)bundleId;' '- (void)runEmbeddedWithArgc:(int)argc argv:(char*[])argv appLaunchOpts:(NSDictionary*)appLaunchOpts;' '- (void)unloadApplication;' '- (void)sendMessageToGOWithName:(const char*)name functionName:(const char*)func message:(const char*)msg;' '- (void)pause:(bool)pause;' '- (void)register:(id<UnityFrameworkListener>)listener;' '- (void)unregisterFrameworkListener:(id<UnityFrameworkListener>)listener;' '- (id)appController;' '@end' '' 'NS_ASSUME_NONNULL_END' > "$FRAMEWORK_PATH/Headers/UnityFramework.h"
              echo "âœ… Generated UnityFramework.h"
              
              # module.modulemap ç”Ÿæˆ
              printf '%s\n' 'framework module UnityFramework {' '  umbrella header "UnityFramework.h"' '  ' '  export *' '  module * { export * }' '}' > "$FRAMEWORK_PATH/Headers/module.modulemap"
              echo "âœ… Generated module.modulemap"
            fi
            
            # Data ç¢ºèª
            if [ -d "$FRAMEWORK_PATH/Data" ]; then
              echo "âœ… Unity Data directory exists"
              echo "Data size: $(du -sh "$FRAMEWORK_PATH/Data")"
            else
              echo "âš ï¸  Unity Data directory missing - creating placeholder"
              mkdir -p "$FRAMEWORK_PATH/Data"
            fi
            
          else
            echo "âš ï¸  UnityFramework.framework directory not found - creating it"
            mkdir -p "$FRAMEWORK_PATH"
          fi
          
          echo "ğŸ¯ Unity as Library setup completed successfully!"
          echo "ğŸ“Š Final structure:"
          ls -la Frameworks/
          
          # 4. Unity Framework ã‚’ Xcode Project ã«çµ±åˆ
          echo "ğŸ”§ Integrating Unity Framework into Xcode project..."
          
          # Runner.xcodeproj ã«Frameworkã‚’è¿½åŠ ï¼ˆæ‰‹å‹•çµ±åˆï¼‰
          echo "ğŸ“± Unity Framework integration will be handled by flutter_unity_widget package"
          
          cd ..
      
      - name: Install CocoaPods dependencies
        script: |
          echo "ğŸ Installing CocoaPods dependencies..."
          cd ios
          
          # Podfileç¢ºèª
          echo "ğŸ“‹ Current Podfile:"
          cat Podfile
          
          # CocoaPods ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
          pod cache clean --all || true
          rm -rf Pods/ || true
          rm -rf ~/Library/Caches/CocoaPods || true
          
          # CocoaPods install
          pod install --repo-update --verbose
      
      - name: Build iOS app (No Code Signing)
        script: |
          # Unity as Libraryçµ±åˆãƒ†ã‚¹ãƒˆç”¨ãƒ“ãƒ«ãƒ‰ï¼ˆç½²åãªã—ï¼‰
          flutter build ios --release \
            --dart-define=GPU_OPTIMIZATION=true \
            --dart-define=NEURAL_ENGINE=true \
            --dart-define=METAL_API=true \
            --dart-define=TARGET_FPS=60 \
            --no-codesign
          
          echo "âœ… Flutter build completed successfully!"
          echo "ğŸ“¦ Build artifacts:"
          ls -la build/ios/Release-iphoneos/
      
      # - name: Build .ipa with Xcode
      #   script: |
      #     xcode-project build-ipa \
      #       --workspace "$XCODE_WORKSPACE" \
      #       --scheme "$XCODE_SCHEME" \
      #       --archive-flags "-destination 'generic/platform=iOS'"
    
    artifacts:
      - build/ios/Release-iphoneos/*.app
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      email:
        recipients:
          - nndds@example.com
        notify:
          success: true
          failure: true
      # app_store_connect:
      #   auth: integration
      #   submit_to_testflight: true
      #   submit_to_app_store: false

  debug-workflow:
    name: iOS Debug Build
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Get Flutter packages
        script: |
          flutter packages pub get
      
      - name: Unity Framework ç¢ºèª
        script: |
          ls -la ios/Frameworks/
          du -sh ios/Frameworks/UnityFramework.framework/
      
      - name: Build debug iOS
        script: |
          # ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ï¼ˆé–‹ç™ºç”¨ï¼‰
          flutter build ios --debug \
            --dart-define=GPU_OPTIMIZATION=false \
            --dart-define=DEBUG_MODE=true \
            --no-codesign
    
    artifacts:
      - build/ios/Debug-iphoneos/*.app